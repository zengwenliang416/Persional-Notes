# ã€Difyã€‘Qdranté•œåƒå¯åŠ¨è¿‡ç¨‹ ğŸ”

## æ¦‚è¿° ğŸ“‹

Qdrantæ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å‘é‡ç›¸ä¼¼åº¦æœç´¢å¼•æ“ï¼Œåœ¨Difyå¹³å°ä¸­ä½œä¸ºå¯é€‰çš„å‘é‡æ•°æ®åº“æœåŠ¡ï¼Œæä¾›é«˜æ€§èƒ½çš„ç›¸ä¼¼åº¦æ£€ç´¢å’Œæ•°æ®ç®¡ç†èƒ½åŠ›ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜Qdranté•œåƒçš„å¯åŠ¨æµç¨‹ã€é…ç½®é€‰é¡¹åŠå…¶åœ¨Difyæ¶æ„ä¸­çš„åº”ç”¨ã€‚

## Qdrantåœ¨Difyä¸­çš„è§’è‰² ğŸ”„

åœ¨Difyæ¶æ„ä¸­ï¼ŒQdrantä½œä¸ºå¯é€‰çš„å‘é‡æ•°æ®åº“æœåŠ¡ï¼Œä¸»è¦è´Ÿè´£ï¼š

1. **å‘é‡ç´¢å¼•ä¸å­˜å‚¨**ï¼šé«˜æ•ˆå­˜å‚¨å’Œç´¢å¼•å‘é‡æ•°æ®ï¼Œæ”¯æŒå¿«é€Ÿçš„ç›¸ä¼¼åº¦æœç´¢
2. **ç›¸ä¼¼åº¦æœç´¢**ï¼šæä¾›å¤šç§è·ç¦»åº¦é‡æ–¹å¼çš„ç›¸ä¼¼åº¦æœç´¢åŠŸèƒ½
3. **è¿‡æ»¤å™¨æ£€ç´¢**ï¼šæ”¯æŒåŸºäºç»“æ„åŒ–å…ƒæ•°æ®çš„å¤åˆè¿‡æ»¤æŸ¥è¯¢
4. **æ•°æ®æŒä¹…åŒ–**ï¼šç¡®ä¿å‘é‡æ•°æ®çš„å®‰å…¨å­˜å‚¨å’ŒæŒä¹…åŒ–ä¿å­˜

Qdranté€šè¿‡Dockerå®¹å™¨åŒ–éƒ¨ç½²ï¼Œä¸ºDifyæä¾›äº†è½»é‡çº§ä½†å¼ºå¤§çš„å‘é‡æ£€ç´¢åŸºç¡€è®¾æ–½ã€‚

## Docker-Composeé…ç½®è§£æ ğŸ”

```yaml
# Qdrantå‘é‡å­˜å‚¨æœåŠ¡
# (å¦‚éœ€ä½¿ç”¨ï¼Œéœ€åœ¨apiå’ŒworkeræœåŠ¡ä¸­è®¾ç½®VECTOR_STOREä¸ºqdrant)
qdrant:
  image: langgenius/qdrant:v1.7.3
  profiles:
    - qdrant
  restart: always
  volumes:
    - ./volumes/qdrant:/qdrant/storage
  environment:
    QDRANT_API_KEY: ${QDRANT_API_KEY:-difyai123456}
```

### å…³é”®é…ç½®ç‚¹è§£æï¼š

1. **é•œåƒç‰ˆæœ¬**ï¼šä½¿ç”¨`langgenius/qdrant:v1.7.3`é•œåƒï¼Œè¿™æ˜¯åŸºäºå®˜æ–¹Qdranté•œåƒçš„å®šåˆ¶ç‰ˆæœ¬
2. **å¯é€‰æœåŠ¡**ï¼šé€šè¿‡`profiles: [qdrant]`é…ç½®ä¸ºå¯é€‰æœåŠ¡ï¼Œéœ€è¦æ—¶æ‰å¯ç”¨
3. **è‡ªåŠ¨é‡å¯**ï¼šè®¾ç½®`restart: always`ç¡®ä¿æœåŠ¡å´©æºƒåè‡ªåŠ¨æ¢å¤
4. **æ•°æ®æŒä¹…åŒ–**ï¼šå°†`./volumes/qdrant`ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…çš„`/qdrant/storage`ç›®å½•ï¼Œç”¨äºå­˜å‚¨æŒä¹…åŒ–æ•°æ®
5. **å®‰å…¨é…ç½®**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡`QDRANT_API_KEY`è®¾ç½®APIå¯†é’¥ï¼Œé»˜è®¤å€¼ä¸º`difyai123456`

## Difyå¹³å°çš„ç›¸å…³ç¯å¢ƒå˜é‡ âš™ï¸

Difyå¹³å°ä¸ºAPIå’ŒWorkeræœåŠ¡æä¾›äº†ä»¥ä¸‹ä¸Qdrantç›¸å…³çš„ç¯å¢ƒå˜é‡é…ç½®ï¼š

```properties
# Qdrantè¿æ¥è®¾ç½®
QDRANT_URL=http://qdrant:6333
QDRANT_API_KEY=difyai123456
QDRANT_CLIENT_TIMEOUT=20
QDRANT_GRPC_ENABLED=false
QDRANT_GRPC_PORT=6334
```

## å¯åŠ¨æµç¨‹ ğŸš€

Qdrantå®¹å™¨çš„å¯åŠ¨è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå…³é”®é˜¶æ®µï¼š

### 1. å®¹å™¨åˆå§‹åŒ–

```mermaid
graph TD
    A[Dockerå¯åŠ¨å®¹å™¨] --> B[åŠ è½½ç¯å¢ƒå˜é‡]
    B --> C[æŒ‚è½½å­˜å‚¨å·]
    C --> D[åˆå§‹åŒ–ç½‘ç»œæ¥å£]
    D --> E[å¯åŠ¨QdrantæœåŠ¡]
```

å½“Dockeråˆ›å»ºå¹¶å¯åŠ¨Qdrantå®¹å™¨æ—¶ï¼š

1. Dockerå¼•æ“è§£ædocker-composeé…ç½®ï¼Œå‡†å¤‡å®¹å™¨ç¯å¢ƒ
2. åŠ è½½ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬`QDRANT_API_KEY`ï¼Œç”¨äºè®¾ç½®APIè®¿é—®çš„å®‰å…¨æ€§
3. æŒ‚è½½`./volumes/qdrant`ç›®å½•åˆ°å®¹å™¨å†…çš„`/qdrant/storage`ï¼Œç¡®ä¿æ•°æ®æŒä¹…åŒ–
4. åˆå§‹åŒ–ç½‘ç»œæ¥å£ï¼Œé»˜è®¤ç›‘å¬ç«¯å£åŒ…æ‹¬ï¼š
   - 6333ï¼šHTTP APIå’ŒWeb UI
   - 6334ï¼šgRPC API
   - 6335ï¼šåˆ†å¸ƒå¼éƒ¨ç½²ï¼ˆé›†ç¾¤å†…éƒ¨é€šä¿¡ï¼‰
5. å¯åŠ¨ä¸»Qdrantè¿›ç¨‹

### 2. é…ç½®åŠ è½½

Qdrantå¯åŠ¨æ—¶æŒ‰ä»¥ä¸‹ä¼˜å…ˆé¡ºåºåŠ è½½é…ç½®ï¼š

1. å†…ç½®é»˜è®¤é…ç½®
2. å¯é€‰çš„`/qdrant/config/config.yaml`æ–‡ä»¶
3. å¯é€‰çš„`/qdrant/config/production.yaml`æ–‡ä»¶ï¼ˆåŸºäºé»˜è®¤RUN_MODE=productionï¼‰
4. å¯é€‰çš„`/qdrant/config/local.yaml`æ–‡ä»¶
5. ç¯å¢ƒå˜é‡ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

åœ¨Difyçš„éƒ¨ç½²ä¸­ï¼Œä¸»è¦é€šè¿‡ç¯å¢ƒå˜é‡`QDRANT_API_KEY`é…ç½®å®‰å…¨æ€§ã€‚

### 3. å­˜å‚¨åˆå§‹åŒ–

æœåŠ¡å¯åŠ¨åï¼ŒQdrantè¿›è¡Œå­˜å‚¨ç³»ç»Ÿåˆå§‹åŒ–ï¼š

1. **æ£€æŸ¥å­˜å‚¨ç›®å½•**ï¼šæ£€æŸ¥å¹¶åˆå§‹åŒ–`/qdrant/storage`ç›®å½•
2. **WALæ¢å¤**ï¼šå¦‚å­˜åœ¨é¢„å†™æ—¥å¿—(WAL)æ–‡ä»¶ï¼Œè¿›è¡Œæ•°æ®æ¢å¤
3. **é›†åˆåŠ è½½**ï¼šåŠ è½½ç°æœ‰çš„å‘é‡é›†åˆ
4. **ç´¢å¼•å‡†å¤‡**ï¼šåˆå§‹åŒ–HNSWç´¢å¼•å’Œå…¶ä»–æ£€ç´¢ç»“æ„

### 4. APIæœåŠ¡å¯åŠ¨

å­˜å‚¨åˆå§‹åŒ–å®Œæˆåï¼ŒQdrantå¯åŠ¨APIæœåŠ¡ï¼š

1. **HTTPæœåŠ¡**ï¼šåœ¨6333ç«¯å£å¯åŠ¨REST APIæœåŠ¡
2. **gRPCæœåŠ¡**ï¼šåœ¨6334ç«¯å£å¯åŠ¨gRPC APIæœåŠ¡ï¼ˆå¦‚å¯ç”¨ï¼‰
3. **Webç•Œé¢**ï¼šåœ¨HTTPç«¯å£æä¾›Dashboard Web UI

## ä¸Difyç»„ä»¶çš„äº¤äº’ ğŸ”—

Qdrantä¸Difyå¹³å°å…¶ä»–ç»„ä»¶çš„äº¤äº’æµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant A as APIæœåŠ¡
    participant W as WorkeræœåŠ¡
    participant Q as QdrantæœåŠ¡
    
    A->>Q: åˆ›å»ºå‘é‡é›†åˆ(HTTP/gRPC)
    A->>Q: é…ç½®é›†åˆå‚æ•°(å‘é‡ç»´åº¦ã€è·ç¦»æ–¹å¼ç­‰)
    W->>Q: æ’å…¥å‘é‡æ•°æ®(å¸¦å…ƒæ•°æ®)
    Q->>Q: æ„å»ºç´¢å¼•
    A->>Q: æ‰§è¡Œç›¸ä¼¼æ€§æœç´¢
    Q->>A: è¿”å›ç›¸ä¼¼ç»“æœ
```

1. **è¿æ¥æœºåˆ¶**ï¼š
   - APIå’ŒWorkeræœåŠ¡é€šè¿‡HTTPæˆ–gRPCåè®®è¿æ¥Qdrant
   - è¿æ¥å‚æ•°é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ŒåŒ…æ‹¬URLã€APIå¯†é’¥å’Œè¶…æ—¶è®¾ç½®

2. **å‘é‡æ“ä½œ**ï¼š
   - é›†åˆç®¡ç†ï¼šé€šè¿‡APIåˆ›å»ºå’Œé…ç½®å‘é‡é›†åˆ
   - æ•°æ®ç´¢å¼•ï¼šWorkeræœåŠ¡å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡åå­˜å…¥Qdrant
   - ç›¸ä¼¼åº¦æœç´¢ï¼šAPIæœåŠ¡å‘é€å‘é‡è¿›è¡Œç›¸ä¼¼åº¦æ£€ç´¢

## Qdrantæ ¸å¿ƒé…ç½®é€‰é¡¹ ğŸ”§

QdrantæœåŠ¡çš„æ ¸å¿ƒé…ç½®é€‰é¡¹åŒ…æ‹¬ï¼š

1. **æ—¥å¿—çº§åˆ«**ï¼š
   ```yaml
   log_level: INFO  # å¯é€‰ï¼šTRACE, DEBUG, INFO, WARN, ERROR
   ```

2. **å­˜å‚¨é…ç½®**ï¼š
   ```yaml
   storage:
     # æ•°æ®å­˜å‚¨ä½ç½®
     storage_path: ./storage
     # å¿«ç…§å­˜å‚¨ä½ç½®
     snapshots_path: ./snapshots
     # payloadå­˜å‚¨æ–¹å¼é…ç½®
     on_disk_payload: true
   ```

3. **æ€§èƒ½è°ƒä¼˜**ï¼š
   ```yaml
   storage:
     performance:
       # æœç´¢çº¿ç¨‹æ•°ï¼Œ0è¡¨ç¤ºè‡ªåŠ¨é€‰æ‹©
       max_search_threads: 0
       # ä¼˜åŒ–çº¿ç¨‹æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶
       max_optimization_threads: 0
   ```

4. **å®‰å…¨é…ç½®**ï¼š
   ```yaml
   service:
     # APIå¯†é’¥ï¼Œç”¨äºè®¿é—®æ§åˆ¶
     api_key: ${QDRANT_API_KEY}
   ```

## ç›‘æ§ä¸æ—¥å¿— ğŸ“Š

QdrantæœåŠ¡çš„ç›‘æ§ä¸æ—¥å¿—ï¼š

1. **æ—¥å¿—æŸ¥çœ‹**ï¼š
   ```bash
   docker compose logs qdrant
   ```

2. **å¥åº·æ£€æŸ¥**ï¼š
   å¯é€šè¿‡HTTPæ¥å£éªŒè¯æœåŠ¡å¥åº·çŠ¶æ€ï¼š
   ```bash
   curl http://qdrant:6333/healthz
   ```
   
3. **æŒ‡æ ‡ç›‘æ§**ï¼š
   Qdrantæä¾›Prometheusæ ¼å¼çš„æŒ‡æ ‡ï¼š
   ```bash
   curl http://qdrant:6333/metrics
   ```

4. **Webç•Œé¢**ï¼š
   é€šè¿‡è®¿é—®`http://qdrant:6333/dashboard`æŸ¥çœ‹å¯è§†åŒ–ç•Œé¢

## æ•…éšœæ’é™¤ ğŸ› ï¸

å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼š

1. **æœåŠ¡æ— æ³•å¯åŠ¨**ï¼š
   - æ£€æŸ¥ç«¯å£(6333, 6334, 6335)æ˜¯å¦è¢«å ç”¨
   - æŸ¥çœ‹Dockeræ—¥å¿—äº†è§£å…·ä½“é”™è¯¯ä¿¡æ¯
   - ç¡®è®¤å­˜å‚¨ç›®å½•æƒé™æ˜¯å¦æ­£ç¡®

2. **APIè¿æ¥å¤±è´¥**ï¼š
   - éªŒè¯`QDRANT_URL`å’Œ`QDRANT_API_KEY`é…ç½®æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
   - å¦‚ä½¿ç”¨gRPCï¼Œç¡®è®¤`QDRANT_GRPC_ENABLED`å’Œ`QDRANT_GRPC_PORT`é…ç½®æ­£ç¡®

3. **æœç´¢æ€§èƒ½é—®é¢˜**ï¼š
   - è°ƒæ•´é›†åˆçš„`hnsw_config`å‚æ•°ä¼˜åŒ–æœç´¢æ€§èƒ½
   - è€ƒè™‘å¢åŠ `max_search_threads`å‚æ•°
   - å¯¹å¤§æ•°æ®é‡è€ƒè™‘å¯ç”¨é‡åŒ–(Quantization)åŠŸèƒ½

## æ•°æ®ç®¡ç†ä¸ä¼˜åŒ– ğŸ’¾

1. **æ•°æ®å¤‡ä»½**ï¼š
   - Qdrantæ•°æ®å­˜å‚¨åœ¨`./volumes/qdrant`ç›®å½•
   - å¯é€šè¿‡å®šæœŸå¤‡ä»½è¯¥ç›®å½•æˆ–ä½¿ç”¨Qdrantå¿«ç…§APIåˆ›å»ºå¤‡ä»½

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä¸ºé›†åˆé€‰æ‹©åˆé€‚çš„å‘é‡è·ç¦»ç±»å‹ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ã€æ¬§æ°è·ç¦»æˆ–ç‚¹ç§¯ï¼‰
   - è°ƒæ•´HNSWç´¢å¼•å‚æ•°ï¼Œå¦‚`m`å’Œ`ef_construct`
   - å¯¹å¤§è§„æ¨¡æ•°æ®è€ƒè™‘å¯ç”¨å‘é‡é‡åŒ–

3. **æ‰©å±•å»ºè®®**ï¼š
   - å•å®ä¾‹éƒ¨ç½²é€‚ç”¨äºä¸­å°è§„æ¨¡åº”ç”¨
   - å¤§å‹ç”Ÿäº§ç¯å¢ƒå¯è€ƒè™‘é…ç½®Qdranté›†ç¾¤æ¨¡å¼
   - èµ„æºå—é™ç¯å¢ƒå¯è°ƒæ•´`on_disk_payload`ä¼˜åŒ–å†…å­˜ä½¿ç”¨

---

> ğŸ‘‰ [English Version](./en/Qdrant_Image_Startup_Process.md) 
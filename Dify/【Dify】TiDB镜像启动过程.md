# ã€Difyã€‘TiDBé•œåƒå¯åŠ¨è¿‡ç¨‹ ğŸ”

## æ¦‚è¿° ğŸ“‹

TiDBæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼SQLæ•°æ®åº“ï¼Œåœ¨Difyå¹³å°ä¸­ä¸»è¦ä½œä¸ºå‘é‡å­˜å‚¨çš„é€‰é¡¹ä¹‹ä¸€ï¼Œæ”¯æŒé«˜æ•ˆçš„å‘é‡æ£€ç´¢å’Œæ•°æ®æŸ¥è¯¢èƒ½åŠ›ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜TiDBé•œåƒçš„å¯åŠ¨æµç¨‹ã€é…ç½®é€‰é¡¹åŠå…¶åœ¨Difyæ¶æ„ä¸­çš„åº”ç”¨ã€‚

## TiDBåœ¨Difyä¸­çš„è§’è‰² ğŸ”„

åœ¨Difyæ¶æ„ä¸­ï¼ŒTiDBä½œä¸ºå¯é€‰çš„å‘é‡æ•°æ®åº“æœåŠ¡ï¼Œä¸»è¦è´Ÿè´£ï¼š

1. **å‘é‡æ•°æ®å­˜å‚¨**ï¼šå­˜å‚¨åµŒå…¥å¼å‘é‡è¡¨ç¤ºï¼Œæ”¯æŒç›¸ä¼¼åº¦æœç´¢
2. **SQLèƒ½åŠ›**ï¼šæä¾›å®Œæ•´çš„SQLæ¥å£ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢æ“ä½œ
3. **æ•°æ®æŒä¹…åŒ–**ï¼šä¿éšœæ•°æ®çš„å¯é å­˜å‚¨å’Œæ¢å¤
4. **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šæ”¯æŒACIDäº‹åŠ¡ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

TiDBé€šè¿‡Dockerå®¹å™¨åŒ–éƒ¨ç½²ï¼Œä¸ºDifyæä¾›äº†å…·å¤‡SQLèƒ½åŠ›çš„å‘é‡å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚

## Docker-Composeé…ç½®è§£æ ğŸ”

```yaml
# TiDBå‘é‡å­˜å‚¨æœåŠ¡
# ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œè¯·å‚è€ƒ https://github.com/pingcap/tidb-docker-compose
tidb:
  image: pingcap/tidb:v8.4.0
  profiles:
    - tidb
  command:
    - --store=unistore
  restart: always
```

### å…³é”®é…ç½®ç‚¹è§£æï¼š

1. **é•œåƒç‰ˆæœ¬**ï¼šä½¿ç”¨`pingcap/tidb:v8.4.0`å®˜æ–¹é•œåƒ
2. **é…ç½®æ–‡ä»¶æœºåˆ¶**ï¼šé€šè¿‡`profiles: [tidb]`é…ç½®ä¸ºå¯é€‰æœåŠ¡
3. **å­˜å‚¨å¼•æ“**ï¼šä½¿ç”¨`--store=unistore`å‚æ•°é…ç½®æœ¬åœ°å­˜å‚¨å¼•æ“
4. **è‡ªåŠ¨é‡å¯**ï¼šè®¾ç½®`restart: always`ç¡®ä¿æœåŠ¡å´©æºƒåè‡ªåŠ¨æ¢å¤
5. **ç®€åŒ–é…ç½®**ï¼šDifyä¸­é‡‡ç”¨äº†æœ€å°åŒ–é…ç½®ï¼Œé€‚ç”¨äºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ

## å¯åŠ¨æµç¨‹ ğŸš€

TiDBå®¹å™¨çš„å¯åŠ¨è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå…³é”®é˜¶æ®µï¼š

### 1. å®¹å™¨åˆå§‹åŒ–

```mermaid
graph TD
    A[Dockerå¯åŠ¨å®¹å™¨] --> B[åŠ è½½ç¯å¢ƒå˜é‡]
    B --> C[è§£æå¯åŠ¨å‚æ•°]
    C --> D[åˆå§‹åŒ–ç½‘ç»œæ¥å£]
    D --> E[å¯åŠ¨TiDBæœåŠ¡]
```

å½“Dockeråˆ›å»ºå¹¶å¯åŠ¨TiDBå®¹å™¨æ—¶ï¼š

1. Dockerå¼•æ“è§£ædocker-composeé…ç½®ï¼Œå‡†å¤‡å®¹å™¨ç¯å¢ƒ
2. åŠ è½½ç¯å¢ƒå˜é‡ï¼Œç¡®å®šè¿è¡Œå‚æ•°
3. è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œç‰¹åˆ«æ˜¯`--store=unistore`å‚æ•°
4. åˆå§‹åŒ–ç½‘ç»œæ¥å£ï¼Œé»˜è®¤ç›‘å¬4000ç«¯å£(MySQLåè®®)å’Œ10080ç«¯å£(HTTPçŠ¶æ€æŠ¥å‘Š)
5. å¯åŠ¨ä¸»TiDBè¿›ç¨‹

### 2. æœåŠ¡åˆå§‹åŒ–

TiDBæœåŠ¡å¯åŠ¨æ—¶ä¼šæ‰§è¡Œä»¥ä¸‹åˆå§‹åŒ–æ­¥éª¤ï¼š

1. **å­˜å‚¨å¼•æ“åˆå§‹åŒ–**ï¼šæ ¹æ®`--store=unistore`å‚æ•°åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨å¼•æ“
2. **æ•°æ®ç›®å½•æ£€æŸ¥**ï¼šæ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤ä¸º`/tmp/tidb`
3. **ç³»ç»Ÿè¡¨åˆ›å»º**ï¼šåˆå§‹åŒ–ç³»ç»Ÿè¡¨å’Œå…ƒæ•°æ®
4. **SQLè§£æå™¨åˆå§‹åŒ–**ï¼šå‡†å¤‡SQLè§£æå’Œæ‰§è¡Œç¯å¢ƒ
5. **äº‹åŠ¡ç®¡ç†å™¨åˆå§‹åŒ–**ï¼šåˆå§‹åŒ–äº‹åŠ¡å¤„ç†ç³»ç»Ÿ

### 3. ç›‘å¬ç«¯å£è®¾ç½®

TiDBé»˜è®¤å¯ç”¨ä¸¤ä¸ªä¸»è¦ç«¯å£ï¼š

1. **4000ç«¯å£**ï¼šMySQLåè®®ç«¯å£ï¼Œç”¨äºSQLè¿æ¥å’Œæ•°æ®æ“ä½œ
2. **10080ç«¯å£**ï¼šHTTPçŠ¶æ€æŠ¥å‘Šç«¯å£ï¼Œæä¾›ç›‘æ§å’Œç®¡ç†æ¥å£

### 4. å­˜å‚¨å¼•æ“å¯åŠ¨

TiDBåœ¨Difyä¸­ä½¿ç”¨çš„æ˜¯æœ¬åœ°å­˜å‚¨å¼•æ“unistoreï¼š

1. **unistoreåˆå§‹åŒ–**ï¼šå¯åŠ¨å†…ç½®çš„unistoreå­˜å‚¨å¼•æ“
2. **å†…å­˜åˆ†é…**ï¼šä¸ºå­˜å‚¨å¼•æ“åˆ†é…å†…å­˜èµ„æº
3. **å­˜å‚¨ç»“æ„åˆ›å»º**ï¼šåˆå§‹åŒ–æ•°æ®å­˜å‚¨ç»“æ„
4. **ç´¢å¼•ç³»ç»Ÿå¯åŠ¨**ï¼šå‡†å¤‡ç´¢å¼•ç³»ç»Ÿä»¥æ”¯æŒé«˜æ•ˆæŸ¥è¯¢

## ä¸Difyç»„ä»¶çš„äº¤äº’ ğŸ”—

TiDBä¸Difyå¹³å°å…¶ä»–ç»„ä»¶çš„äº¤äº’æµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant A as APIæœåŠ¡
    participant W as WorkeræœåŠ¡
    participant T as TiDBæœåŠ¡
    
    A->>T: è¿æ¥TiDB(MySQLåè®®)
    A->>T: æ‰§è¡ŒSQLåˆå§‹åŒ–å‘é‡è¡¨
    W->>T: æäº¤å‘é‡æ•°æ®
    T->>T: å­˜å‚¨å‘é‡å¹¶å»ºç«‹ç´¢å¼•
    A->>T: æ‰§è¡Œå‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢
    T->>A: è¿”å›æŸ¥è¯¢ç»“æœ
```

1. **è¿æ¥æœºåˆ¶**ï¼š
   - APIå’ŒWorkeræœåŠ¡é€šè¿‡MySQLåè®®è¿æ¥TiDB
   - è¿æ¥å‚æ•°ç”±`TIDB_VECTOR_HOST`ã€`TIDB_VECTOR_PORT`ç­‰ç¯å¢ƒå˜é‡é…ç½®

2. **æ•°æ®æ“ä½œ**ï¼š
   - è¡¨åˆ›å»ºï¼šä½¿ç”¨SQLè¯­å¥åˆ›å»ºå‘é‡è¡¨å’Œç´¢å¼•
   - æ•°æ®å†™å…¥ï¼šé€šè¿‡SQLæ’å…¥å‘é‡æ•°æ®
   - å‘é‡æ£€ç´¢ï¼šä½¿ç”¨ç‰¹æ®Šçš„SQLå‡½æ•°è¿›è¡Œç›¸ä¼¼åº¦æŸ¥è¯¢

## ç¯å¢ƒå˜é‡ä¸é…ç½® âš™ï¸

TiDBæœåŠ¡å¯é€šè¿‡ä»¥ä¸‹å…³é”®ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ï¼š

```properties
# TiDBæœåŠ¡å™¨è¿æ¥ä¿¡æ¯
TIDB_VECTOR_HOST=tidb
TIDB_VECTOR_PORT=4000
TIDB_VECTOR_USER=root  # é»˜è®¤ç”¨æˆ·
TIDB_VECTOR_PASSWORD=  # é»˜è®¤æ— å¯†ç 
TIDB_VECTOR_DATABASE=dify  # é»˜è®¤æ•°æ®åº“å

# å­˜å‚¨é…ç½®
# --store=unistoreï¼šä½¿ç”¨æœ¬åœ°å­˜å‚¨å¼•æ“
# --pathï¼šæ•°æ®ç›®å½•ï¼Œé»˜è®¤ä¸º/tmp/tidb
```

## å‘½ä»¤è¡Œå‚æ•°è¯´æ˜ ğŸ”§

TiDBå¯åŠ¨æ—¶çš„ä¸»è¦å‘½ä»¤è¡Œå‚æ•°ï¼š

1. **--store**ï¼š
   - å€¼ä¸º`unistore`ï¼šä½¿ç”¨æœ¬åœ°å­˜å‚¨å¼•æ“ï¼Œé€‚åˆå•æœºæµ‹è¯•ç¯å¢ƒ
   - å€¼ä¸º`tikv`ï¼šä½¿ç”¨åˆ†å¸ƒå¼å­˜å‚¨å¼•æ“ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦é…åˆPDå’ŒTiKVç»„ä»¶

2. **--path**ï¼š
   - å­˜å‚¨å¼•æ“æ•°æ®ç›®å½•
   - æœ¬åœ°å­˜å‚¨å¼•æ“(unistore)é»˜è®¤ä¸º`/tmp/tidb`
   - ä½¿ç”¨`--path=""`å¯å¯ç”¨çº¯å†…å­˜æ¨¡å¼

3. **--host**ï¼š
   - æœåŠ¡ç›‘å¬åœ°å€ï¼Œé»˜è®¤ä¸º`0.0.0.0`
   
4. **-P**ï¼š
   - MySQLåè®®ç«¯å£ï¼Œé»˜è®¤ä¸º`4000`

5. **--status**ï¼š
   - HTTPçŠ¶æ€ç«¯å£ï¼Œé»˜è®¤ä¸º`10080`

## ç›‘æ§ä¸æ—¥å¿— ğŸ“Š

TiDBæœåŠ¡çš„æ—¥å¿—å’Œç›‘æ§ï¼š

1. **æ—¥å¿—æŸ¥çœ‹**ï¼š
   ```bash
   docker compose logs tidb
   ```

2. **å¥åº·æ£€æŸ¥**ï¼š
   å¯é€šè¿‡HTTPæ¥å£éªŒè¯æœåŠ¡å¥åº·çŠ¶æ€ï¼š
   ```bash
   curl http://tidb:10080/status
   ```
   
3. **ç›‘æ§æŒ‡æ ‡**ï¼š
   TiDBæä¾›ä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–ï¼š
   ```bash
   # é€šè¿‡HTTPæ¥å£è·å–æŒ‡æ ‡
   curl http://tidb:10080/metrics
   ```

## æ•…éšœæ’é™¤ ğŸ› ï¸

å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼š

1. **æœåŠ¡æ— æ³•å¯åŠ¨**ï¼š
   - æ£€æŸ¥ç«¯å£(4000å’Œ10080)æ˜¯å¦è¢«å ç”¨
   - æŸ¥çœ‹Dockeræ—¥å¿—äº†è§£å…·ä½“é”™è¯¯ä¿¡æ¯
   - ç¡®è®¤æ•°æ®ç›®å½•æƒé™æ˜¯å¦æ­£ç¡®

2. **è¿æ¥å¤±è´¥**ï¼š
   - éªŒè¯è¿æ¥å‚æ•°(ä¸»æœºã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç )æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
   - ç¡®è®¤TiDBæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

3. **æ€§èƒ½é—®é¢˜**ï¼š
   - æœ¬åœ°å­˜å‚¨å¼•æ“(unistore)ä¸»è¦ç”¨äºæµ‹è¯•ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒçš„å¤§æ•°æ®é‡
   - å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨å®Œæ•´çš„TiDBé›†ç¾¤(TiDB+TiKV+PD)

## æ•°æ®ç®¡ç†ä¸ä¼˜åŒ– ğŸ’¾

1. **æ•°æ®å¤‡ä»½**ï¼š
   - å¯¹äºæœ¬åœ°å­˜å‚¨å¼•æ“ï¼Œå¯é€šè¿‡å¤‡ä»½æ•°æ®ç›®å½•(`/tmp/tidb`)å®ç°
   - ä½¿ç”¨mysqldumpç­‰å·¥å…·å¯¼å‡ºæ•°æ®

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - æœ¬åœ°å­˜å‚¨å¼•æ“é€‚ç”¨äºå¼€å‘æµ‹è¯•ï¼Œæ•°æ®é‡ä¸å®œè¿‡å¤§
   - å¢åŠ å†…å­˜åˆ†é…å¯æé«˜æ€§èƒ½
   - è€ƒè™‘ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢

3. **ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼š
   - å•æœºTiDB+unistoreä»…é€‚ç”¨äºå¼€å‘æµ‹è¯•ç¯å¢ƒ
   - å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨å®Œæ•´çš„TiDBé›†ç¾¤éƒ¨ç½²
   - å‚è€ƒå®˜æ–¹æ–‡æ¡£è¿›è¡Œé›†ç¾¤é…ç½®å’Œä¼˜åŒ–ï¼šhttps://github.com/pingcap/tidb-docker-compose

---

> ğŸ‘‰ [English Version](./en/TiDB_Image_Startup_Process.md) 